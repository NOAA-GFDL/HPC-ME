image: docker:stable

services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: 1
  SECURE_LOG_LEVEL: debug
  CS_SEVERITY_THRESHOLD: MEDIUM
  CS_ANALYZER_IMAGE: registry.gitlab.com/security-products/container-scanning:4

  BUILD_TAG: "2021-11-04"
  BUILD_REPO: git@gitlab.gfdl.noaa.gov:luis.sal-bey/environment_containers.git
  BUILD_REPO_REF: 3114a394da0816599657bc1b3b18477509ee4d49

  REGISTRY: gitlab.gfdl.noaa.gov:5050/luis.sal-bey/environment_containers
  OUTPUT_IMAGE: $REGISTRY/rhel8-gcc:${BUILD_TAG}

stages:
  - build

docker-build:
  stage: build
  tags:
    - docker
  before_script:
    - env
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - cd dockerfile_gcc_env
    - docker build
        --build-arg BUILD_DATE="${BUILD_DATE}"
        --build-arg BUILD_REPO="${BUILD_REPO}"
        --build-arg BUILD_REPO_REF="${BUILD_REPO_REF}"
        --build-arg BUILDKIT_INLINE_CACHE=1
        --tag "${OUTPUT_IMAGE}" .
    - docker push "${OUTPUT_IMAGE}"
