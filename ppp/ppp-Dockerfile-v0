FROM condaforge/mambaforge:latest as builder
LABEL maintainer "Ciheim Brown"

# condaforge is based on a stripped down ubuntu image.  We need some extra bits for frerun + fremake

# apt installs to /usr/bin/
RUN apt update \
  && apt -y install uuid-runtime time csh python bc

# Put postprocessing repo into container
#COPY ./postprocessing /mnt2
RUN git clone --depth 1 https://gitlab.gfdl.noaa.gov/fre2/workflows/postprocessing.git /mnt2 

# Put runscript in container and make it executable
COPY ppp/runscript-v0.sh /exec/runscript.sh
RUN chmod +x /exec/runscript.sh

RUN mkdir /opt/conda/cylc-flow-tools

COPY ppp/cylc-flow-tools.yaml /opt/conda/cylc-flow-tools
COPY ppp/macro.py /tmp

# Finding + replacing the problematic macro.py file with the corrected version
RUN conda env create --file /opt/conda/cylc-flow-tools/cylc-flow-tools.yaml -p /opt/conda/cylc-flow-tools \
  && /bin/bash -c 'export macro=$(find /opt/conda/cylc-flow-tools/lib -wholename */site-packages/metomi/rose) \
  && mv -f /tmp/macro.py $macro/macro.py' \
  && git config --global --add safe.directory /mnt2 \
  && chmod a+w /opt/conda/cylc-flow-tools/lib/python3.11/site-packages \
  && conda config --add pkgs_dirs /opt/conda/cylc-flow-tools/lib/python3.11/site-packages
RUN conda install urwid==2.*

ENTRYPOINT ["/bin/bash"]
