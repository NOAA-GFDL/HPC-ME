FROM continuumio/miniconda3:25.3.1-1 as builder
RUN sed -i -e 's/http:/https:/g' /etc/apt/sources.list.d/debian.sources
RUN apt-get update -y \
 && apt-get install -y csh tcsh which 
RUN conda create -y -n env \
 && conda install -n env conda-forge::nco=5.1.9 conda-forge::r=4.2 conda-forge::cdo=2.4.0 python=3.10 numpy \
 && conda install -n env r-base \
 && conda init
RUN mkdir -p /apps \
 && cd /apps \
 && git clone -b http https://gitlab.gfdl.noaa.gov/esd/fudge.git  
RUN mkdir -p /home/esd/bin/ \
 && cp /apps/fudge/checkout-fudge /home/esd/bin/
ENV PATH="/home/esd/bin:/apps/fudge/bin:/opt/conda/envs/env/bin:$PATH"
SHELL ["/bin/tcsh", "-c"]
RUN echo 'source activate env' >> ~/.cshrc
ENV SHELL container 
RUN mkdir -p /tmpdir
RUN /bin/tcsh -c eval `apps/fudge/checkout-fudge --checkout-dir /tmpdir --fudgetag oreo-20250402`
RUN conda run -n env Rscript -e "install.packages('optparse', repos='https://cloud.r-project.org/')"
RUN cp -r /tmpdir/oreo-20250402 /apps/
RUN chmod -R 777 /apps
ENV PYTHONPATH="/apps/fudge/utils/aux\:/apps/fudge/utils/bin\:/apps/fudge/utils/pp\:/apps/fudge/bin"
ENTRYPOINT ["/bin/tcsh"]
CMD ["tcsh", "-i"]
